name: Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    # Make secrets available to the build command
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      # (Optional) quick sanity check without printing your secrets
      - name: Check secret lengths
        shell: bash
        run: |
          echo "URL LEN: ${#SUPABASE_URL}"
          echo "KEY LEN: ${#SUPABASE_ANON_KEY}"

      - name: Build release APK with dart-define
        shell: bash
        run: |
          flutter build apk --release \
            --build-name="$GITHUB_RUN_NUMBER" \
            --build-number="$GITHUB_RUN_NUMBER" \
            --dart-define=SUPABASE_URL="$SUPABASE_URL" \
            --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          path: build/app/outputs/flutter-apk/app-release.apk
